<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chatbot AI tr∆∞·ªùng THPT L√Ω Th∆∞·ªùng Ki·ªát</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .top-action-bar {  }
        .notify-icon { }
        .notify-badge {  }
        .notify-list {  }
        .notify-title { font-weight: bold; }
        .logout-link { }
        .logout-link:hover {  }
        .history-item { cursor: pointer; transition: background 0.12s; }
        .history-item:hover { background: #f4f7fe; }
        .history-q { font-weight: 500; }
        .history-a { font-size: 14px; }
    </style>
    <script>
      function toggleNotify() {
        var panel = document.getElementById('notify-panel');
        if (panel) {
          panel.style.display = (panel.style.display === 'block' ? 'none' : 'block');
        }
      }
      document.addEventListener('click', function(e) {
        var panel = document.getElementById('notify-panel');
        var icon = document.getElementById('notify-icon');
        if (panel && panel.style.display === 'block' && !panel.contains(e.target) && e.target !== icon) {
            panel.style.display = 'none';
        }
      });

      function toggleAnswer(li){
          var ans = li.querySelector('.history-a');
          if(ans) {
              ans.style.display = (ans.style.display === 'none') ? 'block' : 'none';
          }
      }

      // --- AJAX chat kh√¥ng reload ---
      $(document).ready(function() {
        $('.chat-input-row').on('submit', function(e) {
          e.preventDefault();
          var question = $('.chat-input').val().trim();
          if (!question) return;
          $('.chat-input').prop('disabled', true);
          $('.send-btn').prop('disabled', true);

          // Hi·ªÉn th·ªã t·∫°m th·ªùi message c·ªßa user l√™n chatbox
          var chatBox = $('#chat-box');
          chatBox.append('<div class="chat-message message-user"><div class="message-content"><b>B·∫°n:</b> ' + $('<div>').text(question).html() + '</div></div>');
          chatBox.append('<div class="chat-message message-bot bot-thinking"><div class="message-content"><i>ƒêang tr·∫£ l·ªùi...</i></div></div>');
          chatBox.scrollTop(chatBox[0].scrollHeight);

          // G·ª≠i l√™n API
          fetch('/ask', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ question: question })
          })
          .then(res => res.json())
          .then(data => {
            // X√≥a d√≤ng "ƒêang tr·∫£ l·ªùi..."
            chatBox.find('.bot-thinking').remove();
            // Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi bot
            var answer = data.answer || '<span style="color:#d80000">Kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi.</span>';
            chatBox.append('<div class="chat-message message-bot"><div class="message-content"><b>Bot:</b> ' + $('<div>').text(answer).html().replace(/\n/g,'<br>') + '</div></div>');
            chatBox.scrollTop(chatBox[0].scrollHeight);
            // X√≥a input
            $('.chat-input').val('').focus();
            // Optionally: reload sidebar/history b·∫±ng AJAX n·∫øu mu·ªën
          })
          .catch(err => {
            chatBox.find('.bot-thinking').remove();
            chatBox.append('<div class="chat-message message-bot"><div class="message-content" style="color:red;">C√≥ l·ªói x·∫£y ra, th·ª≠ l·∫°i!</div></div>');
          })
          .finally(() => {
            $('.chat-input').prop('disabled', false);
            $('.send-btn').prop('disabled', false);
          });
        });
      });
    </script>
</head>
<body>

    <div class="container-main">
        <!-- SIDEBAR: L·ªãch s·ª≠ t√¨m ki·∫øm -->
        <div class="history-col">
            <h4>L·ªãch s·ª≠ t√¨m ki·∫øm</h4>
            <ul id="history-list">
                {% if history %}
                    {% for entry in history|reverse %}
                        <li class="history-item" onclick="toggleAnswer(this)">
                            <div class="history-q"><b>?</b> {{ entry.question }}</div>
                            {% if entry.answer %}
                                <div class="history-a" style="display:none;">
                                    <b>ƒê√°p √°n:</b> {{ entry.answer }}
                                </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                {% else %}
                    <li style="color:#888;">Ch∆∞a c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm</li>
                {% endif %}
            </ul>
        </div>
        <!-- KHUNG CHAT (realtime AJAX) -->
        <div class="chat-col">
            <div class="chat-area-main">
                    <div class="top-action-bar">
                        <div class="notify-icon" id="notify-icon" onclick="toggleNotify()">üîî
                            {% if notify_count > 0 %}
                                <span class="notify-badge">{{ notify_count }}</span>
                            {% endif %}
                        </div>
                        <a class="logout-link" href="{{ url_for('logout') }}">ƒêƒÉng xu·∫•t</a>
                        <div id="notify-panel" class="notify-list" style="display:none;">
                            <div class="notify-title">Th√¥ng b√°o m·ªõi:</div>
                            {% if notify_count == 0 %}
                                <div style="color: #777;">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi.</div>
                            {% else %}
                                <ul>
                                {% for n in notifications %}
                                    <li>
                                        <b>C√¢u h·ªèi:</b> {{ n.question }}<br>
                                        {% if n.answer %}
                                            <b>ƒê√°p √°n:</b> {{ n.answer }}
                                        {% else %}
                                            <span style="color:#d80000;">Ch∆∞a c√≥ ƒë√°p √°n, admin s·∫Ω c·∫≠p nh·∫≠t sau!</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                                </ul>
                                <a href="{{ url_for('clear_notify') }}">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc t·∫•t c·∫£</a>
                            {% endif %}
                        </div>
                    </div>
                <div class="chat-header">
                    Chatbot AI tr∆∞·ªùng THPT<br>L√Ω Th∆∞·ªùng Ki·ªát
                </div>
                <div class="chat-box" id="chat-box">
                    {% if not chatbox or chatbox|length == 0 %}
                        <div class="text-secondary py-3 px-2">
                            Xin ch√†o! T√¥i l√† Chatbot AI tr∆∞·ªùng THPT L√Ω Th∆∞·ªùng Ki·ªát.<br>
                            H√£y nh·∫≠p c√¢u h·ªèi ƒë·ªÉ t√¥i h·ªó tr·ª£ b·∫°n.
                        </div>
                    {% else %}
                        {% for entry in chatbox %}
                            <div class="chat-message message-user">
                                <div class="message-content">{{ entry.question }}</div>
                            </div>
                            <div class="chat-message message-bot">
                                <div class="message-content">{{ entry.answer }}</div>
                                <div class="answer-feedback">
                                    <form method="post" action="{{ url_for('rate_answer') }}" style="display:inline;">
                                        <input type="hidden" name="question" value="{{ entry.question }}">
                                        <input type="hidden" name="answer" value="{{ entry.answer }}">
                                        <input type="hidden" name="rate" value="like">
                                        <button type="submit" title="Like" class="btn-like">üëç</button>
                                        <span style="font-size:0.95em; margin-left:2px;">{{ entry.like if entry.like is defined else 0 }}</span>
                                    </form>
                                    <form method="post" action="{{ url_for('rate_answer') }}" style="display:inline;">
                                        <input type="hidden" name="question" value="{{ entry.question }}">
                                        <input type="hidden" name="answer" value="{{ entry.answer }}">
                                        <input type="hidden" name="rate" value="unlike">
                                        <button type="submit" title="Kh√¥ng th√≠ch" class="btn-unlike">üëé</button>
                                        <span style="font-size:0.95em; margin-left:2px;">{{ entry.unlike if entry.unlike is defined else 0 }}</span>
                                    </form>
                                </div>

                            </div>


                        {% endfor %}
                    {% endif %}
                </div>
                <form class="chat-input-row" autocomplete="off" style="margin-top:15px;">
                    <input class="chat-input" type="text" name="question" placeholder="Nh·∫≠p c√¢u h·ªèi..." autocomplete="off" required>
                    <button class="send-btn" type="submit">G·ª≠i</button>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
